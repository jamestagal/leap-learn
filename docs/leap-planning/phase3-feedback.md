This is a really well-structured plan. The scope is clear, the implementation order is logical, and the critical design decisions section is particularly strong — the student identity model analysis and the decision to separate maxLearners from maxMembers is exactly right for a multi-tenant LMS.
Here's what I'd flag as gaps or considerations:
xAPI capture reliability. The current design fires xAPI statements via fetch() from the browser in a message event listener. If the learner closes the tab mid-activity, or their connection drops, those statements are lost silently. For scored/completed events this matters — a student finishes a quiz, the completion fires, but the POST fails and their progress never records. Two things worth considering: first, use navigator.sendBeacon() as a fallback on beforeunload for any queued statements that haven't been acknowledged. Second, add a small client-side buffer (even just an array in memory) that retries failed POSTs on the next successful interaction. You don't need a full offline queue for Phase 3, but the beacon fallback is a one-liner that prevents the most common data loss scenario.
The enrolment-to-progress initialisation has a race condition. Step 2 says enrolInCourse creates progress_records for each existing course_item. But what happens when a teacher adds a new item to a published course after students have enrolled? Those students won't have progress_records rows for the new item. Their completion percentage calculation (completed_items / total_items) will be wrong because total_items comes from progress_records count, not from course_items count. You need to decide: does the progress query join against course_items to get the true total (and treat missing progress_records as "not started"), or do you backfill progress_records when items are added? I'd recommend the former — query against course_items with a LEFT JOIN to progress_records, and treat NULL as not started. It's simpler and handles the edge case without needing a backfill job. Your aggregation queries in Step 2 already LEFT JOIN, but they count pr.id for total_items which would miss items without progress rows. Change total_items to come from a subquery on course_items instead.
Course item removal while students are enrolled. Related to the above — if a teacher removes a course item that students have already completed, their progress_records rows become orphaned (the course_item_id foreign key is gone if you hard delete). The plan says removeCourseItem is a hard delete. Either soft-delete course items, or cascade the delete to progress_records and accept that historical data is lost. I'd lean toward soft delete with a removed_at timestamp, and exclude removed items from the learning player but keep them in progress calculations so students don't lose credit for work they've done.
The permission matrix uses "Member" but the tier discussion uses "learner." This is a naming clarity issue that could confuse the implementing agent. The matrix shows Owner/Admin/Member, the tier limits say maxLearners, and the decision section says "members ARE learners." Worth adding a single line to the permissions section explicitly stating that "Member" in the permission matrix corresponds to the learner role, and that maxLearners is enforced at enrolment time (not at org membership time). Otherwise someone might wire the limit check to org invitation instead of course enrolment.
No handling for course_items with item_type of text/video/link in progress tracking. The enrolment flow says it creates progress_records only for items where item_type='h5p'. That's correct because only H5P items emit xAPI. But text/video/link items won't have progress rows, which means they're invisible to the completion calculation. If a course has 5 items (3 H5P + 1 text + 1 video), is the course 100% complete when 3/3 H5P items are done, or 3/5 items are done? You should decide this explicitly. My suggestion: for Phase 3, create progress records for all item types, and mark text/link items as auto-completed on first view (a simple "experienced" xAPI-style event when the student navigates to them). Video items could be auto-completed on view or left manual. This keeps the completion math clean.
No course ordering/sorting for the student view. The learning dashboard (/learn) lists enrolled courses but doesn't specify sort order. For a student with multiple enrolments, "most recently active" (last progress update) is almost always the right default. Worth specifying.
Missing: what happens when a course is archived or unpublished while students are enrolled. The plan doesn't address this. If a teacher archives a course, can enrolled students still access their progress? Can they still complete in-progress items? I'd suggest: archived courses remain viewable to enrolled students (read-only, they can review their progress and revisit content) but don't accept new enrolments. This prevents data loss without requiring complex state management.
The xAPI endpoint derives org_id from content, but it should also verify the user is enrolled. Step 3 says the Go handler looks up org_id from h5p_content. But it should also verify that the authenticated user has an active enrolment in a course that contains this content item, or at minimum is an org member. Otherwise any authenticated user could POST xAPI statements for any content item. The check is: does this user have an active enrolment in a course that includes this content_id? Or more permissively: is this user a member of the org that owns this content? The permissive check is probably fine for Phase 3 since content can be played outside of course context too (from the content library directly).
Time estimate feels tight for the component rewiring. The plan acknowledges that CourseManager.svelte is likely a full rewrite and LearningPlayer.svelte needs significant adaptation, but the total estimate is 31 hours. The component adaptation notes suggest medium-to-high effort across several components. I'd budget an extra day (8 hours) as a buffer, particularly for the learning player route (Step 8) which combines H5P iframe rendering, xAPI event capture, navigation state, and progress sidebar — that's the most integration-heavy screen in the whole phase.
One small schema consideration. The progress_records table has content_id and user_id columns directly, plus enrolment_id. This means user_id is denormalised (it's already on the enrolment). That's fine for query convenience, but if a user could be enrolled in multiple courses that share the same H5P content item, you'd want progress tracked per-enrolment, not per-content-item globally. The current schema does this correctly (the unique constraint should be on enrolment_id + course_item_id, which is what you have in the blueprint). Just make sure the queries always scope through enrolment_id rather than user_id + content_id to avoid cross-course progress bleed.
Everything else — the route structure, the remote function API design, the xAPI pipeline, the phased permission model, the navigation updates — looks solid and ready to hand off.great thanks does this plan address the course creation and management? and should it or should it be a separate spec/plan?15:16Evaluated whether Phase 3 adequately encompasses course creation managementEvaluated whether Phase 3 adequately encompasses course creation managementThe user is asking whether the Phase 3 plan adequately covers course creation and management, or if that needs a separate spec.DoneThe plan does cover course creation and management, but at a fairly thin level — it's more of a routing and wiring spec than a feature spec. Let me be specific about what's there versus what's missing.
What's covered well: the route structure (/courses, /courses/new, /courses/[courseId], /courses/[courseId]/edit), the remote function signatures (create, update, delete, publish, add/remove/reorder items), the course builder wiring to CourseStructureEditor.svelte, and the tabbed detail view layout (Content, Learners, Settings). That's enough for an agent to build the scaffolding.
What's underspecified for course creation and management specifically:
The course builder is described as "add H5P content via modal, add text item inline, drag to reorder, publish with validation" — but the actual authoring experience isn't detailed. When a teacher adds an H5P content item, what does the picker look like? Is it a searchable grid of the org's published content? Can they filter by content type? Can they preview before adding? What metadata do they set per item (just title, or also description, estimated duration, required vs optional)? The plan says addCourseItem(data) takes course_id, content_id, item_type, title — but in practice the course builder is the screen teachers will spend the most time on, and the UX decisions matter.
The text/video/link item types are mentioned in the schema but have zero implementation detail. What does "Add Text Item" actually render — a rich text editor? Markdown? Plain textarea? For video items, is it a URL input that embeds YouTube/Vimeo, or a file upload to R2? For link items, is it just a URL with a title? These each need at least a sentence of spec.
Course settings are almost entirely missing. The plan mentions a Settings tab with "title, description, cover image, status toggle, delete" — but there's no mention of the settings that actually affect the learning experience: is_self_paced, require_sequential, passing_score. These columns exist in the schema from the architecture blueprint. Are they exposed in Phase 3 or deferred?
The publish flow says "validate has ≥1 item, all linked H5P content is published" which is good, but doesn't cover the unpublish/archive transitions. Can a teacher unpublish a course back to draft? What happens to active enrolments? Can they archive directly from published? The state machine for draft → published → archived (and whether backward transitions are allowed) needs a sentence or two.
Cover image upload is mentioned but not detailed. Does it use the existing R2 upload flow? Is there a default/placeholder? Cropping? This is minor but an agent will hit the question immediately.
My recommendation: keep it in this plan, but add a subsection under Step 4 that fleshes out the course builder UX. It doesn't need to be a separate spec because course creation isn't architecturally complex — it's standard CRUD with a drag-drop list and a content picker modal. The learning side (Steps 5-8) is actually the harder part and that's well-covered. You'd probably want to add around 30-40 lines covering the content picker modal behaviour, the text/video/link item implementations (even just "Phase 3: text items only, rendered as HTML via a simple rich text input; video and link items deferred to Phase 4"), the course status state machine, and which course settings are exposed in the Settings tab.
Splitting it into a separate spec would make sense if the course builder were a complex multi-step wizard with conditional logic, templates, or AI-assisted course generation. But for Phase 3 it's fundamentally "create a course, add items to it in order, publish it." That fits naturally as a more detailed Step 4 in the existing plan rather than a standalone document.